<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shipping Tracker Calendar</title>
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Noto Sans KR", sans-serif;
      }
      .fc-event-time {
        display: none;
      }
      .fc-tooltip {
        padding: 8px 12px;
        line-height: 1.34;
        font-size: 14px;
        border-radius: 4px;
      }
      .fc-multimonth-title {
        background-color: #2c3e50;
        color: #ffffff;
      }
      .fc-daygrid-event {
        overflow: hidden;
      }

      /* 모달 스타일 */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }
      .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 0;
        border: 1px solid #888;
        width: 90%;
        max-width: 800px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-height: 80vh;
        overflow-y: auto;
      }
      .modal-header {
        padding: 12px 20px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .modal-body {
        padding: 20px;
      }
      .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.2s;
      }
      .close:hover,
      .close:focus {
        color: #000;
      }

      /* 필터 아이콘 스타일 */
      .filter-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #e5e7eb;
        border: none;
        border-radius: 50%;
        width: 46px;
        height: 46px;
        cursor: pointer;
        z-index: 100;
        svg {
          width: 24px;
          height: 24px;
          color: #2c3e50;
        }
      }
      .filter-icon:hover {
        border: 2px solid #2c3e50;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      #calendar {
        padding-top: 0;
        font-size: 14px;
      }
      .fc .fc-toolbar.fc-header-toolbar {
        position: sticky;
        top: 0;
        z-index: 2;
        background: #fff;
        padding: 1rem 0;
        border-bottom: 1px solid #eee;
        margin-bottom: -1px;
      }

      /* 사이드바 스타일 */
      #sidebar {
        width: 260px;
        min-width: 260px;
        height: 100vh;
        background-color: #f8f9fa;
        border-right: 1px solid #e9ecef;
        overflow-y: auto;
        padding: 20px;
      }
      #sidebar h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        color: #2c3e50;
      }
      #sidebar h4 {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #495057;
      }
      .sidebar-section {
        margin-bottom: 24px;
      }
      #main-container {
        display: flex;
        min-height: 100vh;
      }
      #main-content {
        flex: 1;
        overflow-x: hidden;
        height: 100vh;
      }
    </style>
  </head>
  <body class="m-0 bg-gray-100">
    <div id="main-container">
      <!-- PC 사이드바 -->
      <div id="sidebar" class="hidden md:block">
        <h1 class="text-xl font-bold text-gray-800 mb-6">Shipping Schedule</h1>

        <!-- 루트 선택 -->
        <div class="sidebar-section">
          <h3>루트 선택</h3>
          <select
            id="routeSelectorSidebar"
            class="w-full px-2 py-1.5 border border-gray-300 rounded-lg bg-white text-gray-700 hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
            onchange="changeRoute()"
          >
            <option value="east_asia">EAST ASIA</option>
            <option value="asia_africa">ASIA, AFRICA</option>
          </select>
        </div>

        <!-- 필터 설정 -->
        <div class="sidebar-section">
          <p class="text-sm text-gray-600 mb-3">
            필터링된 스케줄:
            <span id="filteredCountSidebar" class="font-semibold text-blue-600"
              >0</span
            >건
          </p>
        </div>

        <!-- 회사 필터 -->
        <div class="sidebar-section">
          <h3>회사 선택</h3>
          <div class="flex items-center mb-2">
            <input type="checkbox" id="selectAllSidebar" class="mr-2" checked />
            <label
              for="selectAllSidebar"
              class="cursor-pointer text-sm font-semibold"
              >전체 선택/해제</label
            >
          </div>
          <div
            id="companyCheckboxesSidebar"
            class="grid grid-cols-2 gap-1"
          ></div>
        </div>

        <!-- 포트 필터 -->
        <div class="sidebar-section">
          <!-- 출발 포트 -->
          <div class="mb-4">
            <h3 class="text-sm font-semibold text-gray-600 mb-2">출발 포트</h3>
            <div class="flex items-center mb-2">
              <input
                type="checkbox"
                id="selectAllDeparturePortsSidebar"
                class="mr-2"
              />
              <label
                for="selectAllDeparturePortsSidebar"
                class="cursor-pointer text-xs"
                >전체 선택/해제</label
              >
            </div>
            <div
              id="departurePortCheckboxesSidebar"
              class="grid grid-cols-2 gap-1"
            ></div>
          </div>

          <!-- 도착 포트 -->
          <div>
            <h3 class="text-sm font-semibold text-gray-600 mb-2">도착 포트</h3>
            <div class="flex items-center mb-2">
              <input
                type="checkbox"
                id="selectAllArrivalPortsSidebar"
                class="mr-2"
              />
              <label
                for="selectAllArrivalPortsSidebar"
                class="cursor-pointer text-xs"
                >전체 선택/해제</label
              >
            </div>
            <div
              id="arrivalPortCheckboxesSidebar"
              class="grid grid-cols-2 gap-1"
            ></div>
          </div>
        </div>
      </div>

      <!-- 메인 컨텐츠 -->
      <div id="main-content" class="flex-1">
        <!-- SP 헤더 -->
        <div
          class="flex justify-between items-center gap-4 p-3 mb-4 mx-auto max-w-[1440px]"
        >
          <h1 class="text-gray-800 text-2xl font-bold md:hidden">
            Shipping Schedule
          </h1>

          <div class="flex items-center gap-3">
            <!-- 루트 선택 드롭다운 (SP만) -->
            <select
              id="routeSelector"
              class="md:hidden px-2.5 py-1.5 border border-gray-300 rounded-lg bg-white text-gray-700 font-medium hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
              onchange="changeRoute()"
            >
              <option value="east_asia">EAST ASIA</option>
              <option value="asia_africa">ASIA, AFRICA</option>
            </select>

            <!-- 필터 아이콘 (SP만) -->
            <button
              class="filter-icon md:hidden"
              onclick="openModal()"
              title="필터 설정"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
                class="size-6"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 0 1-.659 1.591l-5.432 5.432a2.25 2.25 0 0 0-.659 1.591v2.927a2.25 2.25 0 0 1-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 0 0-.659-1.591L3.659 7.409A2.25 2.25 0 0 1 3 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0 1 12 3Z"
                />
              </svg>
            </button>
          </div>
        </div>

        <!-- 필터 모달 (SP 전용) -->
        <div id="filterModal" class="modal md:hidden">
          <div class="modal-content">
            <div class="modal-header">
              <div>
                <h2 class="text-lg font-semibold text-gray-800">필터 설정</h2>
                <p class="text-sm text-gray-600 mt-1">
                  필터링된 스케줄:
                  <span id="filteredCount" class="font-semibold text-blue-600"
                    >0</span
                  >건
                </p>
              </div>
              <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 회사 필터 -->
                <div>
                  <h3 class="text-gray-700 font-semibold mb-3">회사 선택:</h3>
                  <div class="flex items-center mb-3">
                    <input
                      type="checkbox"
                      id="selectAll"
                      class="mr-2"
                      checked
                    />
                    <label
                      for="selectAll"
                      class="cursor-pointer font-semibold text-sm"
                      >전체 선택/해제</label
                    >
                  </div>
                  <div
                    id="companyCheckboxes"
                    class="grid grid-cols-2 gap-2"
                  ></div>
                </div>

                <!-- 포트 필터 -->
                <div>
                  <!-- 출발 포트 -->
                  <div class="mb-4">
                    <h3 class="text-gray-600 font-semibold mb-2 text-sm">
                      출발 포트
                    </h3>
                    <div class="flex items-center mb-2">
                      <input
                        type="checkbox"
                        id="selectAllDeparturePorts"
                        class="mr-2"
                      />
                      <label
                        for="selectAllDeparturePorts"
                        class="cursor-pointer text-sm"
                        >전체 선택/해제</label
                      >
                    </div>
                    <div
                      id="departurePortCheckboxes"
                      class="grid grid-cols-2 gap-2"
                    ></div>
                  </div>

                  <!-- 도착 포트 -->
                  <div>
                    <h3 class="text-gray-600 font-semibold mb-2 text-sm">
                      도착 포트
                    </h3>
                    <div class="flex items-center mb-2">
                      <input
                        type="checkbox"
                        id="selectAllArrivalPorts"
                        class="mr-2"
                      />
                      <label
                        for="selectAllArrivalPorts"
                        class="cursor-pointer text-sm"
                        >전체 선택/해제</label
                      >
                    </div>
                    <div
                      id="arrivalPortCheckboxes"
                      class="grid grid-cols-2 gap-2"
                    ></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="p-3 md:p-5 mx-auto w-full">
          <div
            id="calendar"
            class="bg-white rounded-lg shadow-lg py-3 px-4 overflow-auto"
          ></div>
        </div>
      </div>
    </div>

    <script>
      // 모달 열기/닫기 함수
      function openModal() {
        document.getElementById("filterModal").style.display = "block";
        document.body.style.overflow = "hidden"; // 배경 스크롤 방지
      }

      function closeModal() {
        document.getElementById("filterModal").style.display = "none";
        document.body.style.overflow = "auto"; // 배경 스크롤 복원
      }

      // 모달 외부 클릭 시 닫기
      window.onclick = function (event) {
        const modal = document.getElementById("filterModal");
        if (event.target === modal) {
          closeModal();
        }
      };

      // ESC 키로 모달 닫기
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          closeModal();
        }
      });

      let shippingData = [];
      let calendar = null;
      let selectedCompanies = [];
      let selectedDeparturePorts = []; // 출발 포트 선택
      let selectedArrivalPorts = []; // 도착 포트 선택
      let companyColors = {}; // 회사별 색상 맵
      let currentRoute = "east_asia"; // 현재 선택된 루트

      // 루트별 JSON URL 설정
      const routeUrls = {
        east_asia:
          "https://raw.githubusercontent.com/taimouse/autocom-shipping-tracker/refs/heads/master/shipping_history_east_asia.json",
        asia_africa:
          "https://raw.githubusercontent.com/taimouse/autocom-shipping-tracker/refs/heads/master/shipping_history_asia_africa.json",
      };

      // 색상 팔레트 (회사 수만큼 반복 사용) - 500톤 색상
      const colorPalette = [
        "#2196F3", // 파란색 500
        "#4CAF50", // 초록색 500
        "#FF9800", // 주황색 500
        "#9C27B0", // 보라색 500
        "#009688", // 청록색 500
        "#607D8B", // 청회색 500
        "#795548", // 갈색 500
        "#FFEB3B", // 노란색 500
        "#F44336", // 빨간색 500
        "#00BCD4", // 청록색 500
      ];

      // 루트 변경 함수
      function changeRoute() {
        const selectorMobile = document.getElementById("routeSelector");
        const selectorSidebar = document.getElementById("routeSelectorSidebar");

        // 어느 쪽에서 변경되었는지 확인하고 다른 쪽 동기화
        if (event && event.target.id === "routeSelector") {
          currentRoute = selectorMobile.value;
          if (selectorSidebar) selectorSidebar.value = currentRoute;
        } else if (event && event.target.id === "routeSelectorSidebar") {
          currentRoute = selectorSidebar.value;
          if (selectorMobile) selectorMobile.value = currentRoute;
        } else {
          // 초기 로드 시
          currentRoute = selectorMobile
            ? selectorMobile.value
            : selectorSidebar
              ? selectorSidebar.value
              : "east_asia";
        }

        loadShippingData(routeUrls[currentRoute]);
      }

      // JSON 데이터 로드 함수
      function loadShippingData(url) {
        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            shippingData = data;
            // 회사명 변환 (긴 이름은 짧게)
            const companyNameMap = {
              "SEVEN SEALS CO.,LTD": "SEALS",
              "THE KEIHIN CO., LTD.": "KEIHIN",
            };
            shippingData.forEach((ship) => {
              ship.Company = companyNameMap[ship.Company] || ship.Company;
            });
            companyColors = {}; // 색상 맵 초기화
            populateCompanySelect();
            populatePortSelect();
            if (calendar) {
              calendar.destroy();
            }
            initCalendars();
          })
          .catch((error) => console.error("Error loading JSON:", error));
      }

      // 초기 로드
      loadShippingData(routeUrls[currentRoute]);

      // 회사 목록을 checkbox로 추가 (PC/SP 양쪽)
      function populateCompanySelect() {
        const companies = [
          ...new Set(shippingData.map((ship) => ship.Company)),
        ].sort();

        // 초기화: 모든 회사 선택
        selectedCompanies = [...companies];

        // 회사별 색상 할당
        companies.forEach((company, index) => {
          companyColors[company] = colorPalette[index % colorPalette.length];
        });

        // SP 모달 생성
        createCompanyCheckboxes(
          companies,
          "companyCheckboxes",
          "selectAll",
          false,
        );

        // PC 사이드바 생성
        createCompanyCheckboxes(
          companies,
          "companyCheckboxesSidebar",
          "selectAllSidebar",
          true,
        );
      }

      // 회사 체크박스 생성 헬퍼 함수
      function createCompanyCheckboxes(
        companies,
        containerId,
        selectAllId,
        isSidebar,
      ) {
        const container = document.getElementById(containerId);
        const selectAllCheckbox = document.getElementById(selectAllId);

        if (!container || !selectAllCheckbox) return;

        // 기존 체크박스 제거
        container.innerHTML = "";

        companies.forEach((company) => {
          const div = document.createElement("div");
          div.className = "flex items-center";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = `company_${company.replace(/\s+/g, "_")}_${isSidebar ? "sidebar" : "modal"}`;
          checkbox.value = company;
          checkbox.checked = true;
          checkbox.className = `mr-2 company-checkbox-${isSidebar ? "sidebar" : "modal"}`;
          checkbox.dataset.company = company;

          const label = document.createElement("label");
          label.htmlFor = checkbox.id;
          label.textContent = company;
          label.className = "cursor-pointer text-xs";

          div.appendChild(checkbox);
          div.appendChild(label);
          container.appendChild(div);

          // checkbox 변경 이벤트 - 양쪽 동기화
          checkbox.addEventListener("change", (e) => {
            const company = e.target.dataset.company;
            const isChecked = e.target.checked;

            // 전역 상태 업데이트
            if (isChecked) {
              if (!selectedCompanies.includes(company)) {
                selectedCompanies.push(company);
              }
            } else {
              selectedCompanies = selectedCompanies.filter(
                (c) => c !== company,
              );
            }

            // 반대편 체크박스 동기화
            const otherCheckboxes = document.querySelectorAll(
              `input[data-company="${company}"]`,
            );
            otherCheckboxes.forEach((cb) => {
              if (cb !== e.target) cb.checked = isChecked;
            });

            updateSelectAllCheckbox();
            updateCalendar();
          });
        });

        // 전체 선택/해제 이벤트
        const newSelectAll = selectAllCheckbox.cloneNode(true);
        selectAllCheckbox.replaceWith(newSelectAll);

        document.getElementById(selectAllId).addEventListener("change", (e) => {
          const isChecked = e.target.checked;
          const checkboxes = document.querySelectorAll(
            `.company-checkbox-${isSidebar ? "sidebar" : "modal"}`,
          );

          checkboxes.forEach((cb) => {
            cb.checked = isChecked;
          });

          // 전역 상태 업데이트
          selectedCompanies.splice(0, selectedCompanies.length);
          if (isChecked) {
            selectedCompanies.push(...companies);
          }

          // 반대편 전체 선택 동기화
          const otherSelectAll = document.getElementById(
            isSidebar ? "selectAll" : "selectAllSidebar",
          );
          if (otherSelectAll) otherSelectAll.checked = isChecked;

          // 반대편 개별 체크박스 동기화
          const otherCheckboxes = document.querySelectorAll(
            `.company-checkbox-${isSidebar ? "modal" : "sidebar"}`,
          );
          otherCheckboxes.forEach((cb) => (cb.checked = isChecked));

          updateCalendar();
        });
      }

      // 전체 선택 체크박스 상태 업데이트 (PC/SP 양쪽)
      function updateSelectAllCheckbox() {
        // SP 모달
        const checkboxesModal = document.querySelectorAll(
          ".company-checkbox-modal",
        );
        const selectAllModal = document.getElementById("selectAll");
        if (checkboxesModal.length > 0 && selectAllModal) {
          const allCheckedModal = Array.from(checkboxesModal).every(
            (cb) => cb.checked,
          );
          selectAllModal.checked = allCheckedModal;
        }

        // PC 사이드바
        const checkboxesSidebar = document.querySelectorAll(
          ".company-checkbox-sidebar",
        );
        const selectAllSidebar = document.getElementById("selectAllSidebar");
        if (checkboxesSidebar.length > 0 && selectAllSidebar) {
          const allCheckedSidebar = Array.from(checkboxesSidebar).every(
            (cb) => cb.checked,
          );
          selectAllSidebar.checked = allCheckedSidebar;
        }
      }

      // 포트 목록을 checkbox로 추가 (출발/도착 포트 별도 필터링, PC/SP 양쪽)
      function populatePortSelect() {
        const departurePorts = new Set();
        const arrivalPorts = new Set();

        // 출발 포트와 도착 포트 각각 수집
        shippingData.forEach((ship) => {
          Object.keys(ship["Departure Ports"]).forEach((port) =>
            departurePorts.add(port),
          );
          Object.keys(ship["Arrival Ports"]).forEach((port) =>
            arrivalPorts.add(port),
          );
        });

        const departurePortsList = [...departurePorts].sort();
        const arrivalPortsList = [...arrivalPorts].sort();

        // 루트별 초기 포트 선택
        selectedDeparturePorts.splice(0, selectedDeparturePorts.length);
        selectedArrivalPorts.splice(0, selectedArrivalPorts.length);

        if (currentRoute === "east_asia") {
          if (arrivalPortsList.includes("Hambantota")) {
            selectedArrivalPorts.push("Hambantota");
          }
        } else if (currentRoute === "asia_africa") {
          if (arrivalPortsList.includes("Mombasa")) {
            selectedArrivalPorts.push("Mombasa");
          }
        }

        // SP 모달 생성
        createPortCheckboxes(
          departurePortsList,
          "departurePortCheckboxes",
          "departure-port-checkbox-modal",
          selectedDeparturePorts,
          false,
        );
        createPortCheckboxes(
          arrivalPortsList,
          "arrivalPortCheckboxes",
          "arrival-port-checkbox-modal",
          selectedArrivalPorts,
          false,
        );

        // PC 사이드바 생성
        createPortCheckboxes(
          departurePortsList,
          "departurePortCheckboxesSidebar",
          "departure-port-checkbox-sidebar",
          selectedDeparturePorts,
          true,
        );
        createPortCheckboxes(
          arrivalPortsList,
          "arrivalPortCheckboxesSidebar",
          "arrival-port-checkbox-sidebar",
          selectedArrivalPorts,
          true,
        );

        // 전체 선택 이벤트 설정
        setupPortSelectAllEvents(departurePortsList, arrivalPortsList);
      }

      // 포트 전체 선택 이벤트 설정
      function setupPortSelectAllEvents(departurePortsList, arrivalPortsList) {
        // 출발 포트 전체 선택 - SP
        const selectAllDepartureModal = document.getElementById(
          "selectAllDeparturePorts",
        );
        if (selectAllDepartureModal) {
          const newEl = selectAllDepartureModal.cloneNode(true);
          selectAllDepartureModal.replaceWith(newEl);
          newEl.addEventListener("change", (e) => {
            handlePortSelectAll(
              e.target.checked,
              departurePortsList,
              selectedDeparturePorts,
              "departure-port-checkbox-modal",
              "departure-port-checkbox-sidebar",
            );
          });
        }

        // 출발 포트 전체 선택 - PC
        const selectAllDepartureSidebar = document.getElementById(
          "selectAllDeparturePortsSidebar",
        );
        if (selectAllDepartureSidebar) {
          const newEl = selectAllDepartureSidebar.cloneNode(true);
          selectAllDepartureSidebar.replaceWith(newEl);
          newEl.addEventListener("change", (e) => {
            handlePortSelectAll(
              e.target.checked,
              departurePortsList,
              selectedDeparturePorts,
              "departure-port-checkbox-sidebar",
              "departure-port-checkbox-modal",
            );
          });
        }

        // 도착 포트 전체 선택 - SP
        const selectAllArrivalModal = document.getElementById(
          "selectAllArrivalPorts",
        );
        if (selectAllArrivalModal) {
          const newEl = selectAllArrivalModal.cloneNode(true);
          selectAllArrivalModal.replaceWith(newEl);
          newEl.addEventListener("change", (e) => {
            handlePortSelectAll(
              e.target.checked,
              arrivalPortsList,
              selectedArrivalPorts,
              "arrival-port-checkbox-modal",
              "arrival-port-checkbox-sidebar",
            );
          });
        }

        // 도착 포트 전체 선택 - PC
        const selectAllArrivalSidebar = document.getElementById(
          "selectAllArrivalPortsSidebar",
        );
        if (selectAllArrivalSidebar) {
          const newEl = selectAllArrivalSidebar.cloneNode(true);
          selectAllArrivalSidebar.replaceWith(newEl);
          newEl.addEventListener("change", (e) => {
            handlePortSelectAll(
              e.target.checked,
              arrivalPortsList,
              selectedArrivalPorts,
              "arrival-port-checkbox-sidebar",
              "arrival-port-checkbox-modal",
            );
          });
        }
      }

      // 포트 전체 선택 핸들러
      function handlePortSelectAll(
        isChecked,
        portsList,
        selectedArray,
        thisClass,
        otherClass,
      ) {
        // 현재 쪽 체크박스 업데이트
        const thisCheckboxes = document.querySelectorAll(`.${thisClass}`);
        thisCheckboxes.forEach((cb) => (cb.checked = isChecked));

        // 반대쪽 체크박스 업데이트
        const otherCheckboxes = document.querySelectorAll(`.${otherClass}`);
        otherCheckboxes.forEach((cb) => (cb.checked = isChecked));

        // 전역 상태 업데이트
        selectedArray.splice(0, selectedArray.length);
        if (isChecked) {
          selectedArray.push(...portsList);
        }

        updateSelectAllPortsCheckbox();
        updateCalendar();
      }

      // 포트 체크박스 생성 헬퍼 함수 (PC/SP 동기화)
      function createPortCheckboxes(
        ports,
        containerId,
        checkboxClass,
        selectedArray,
        isSidebar,
      ) {
        const container = document.getElementById(containerId);
        if (!container) return;

        // 기존 체크박스 제거
        container.innerHTML = "";

        ports.forEach((port) => {
          const div = document.createElement("div");
          div.className = "flex items-center";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = `${checkboxClass}_${port.replace(/\s+/g, "_")}`;
          checkbox.value = port;
          checkbox.checked = selectedArray.includes(port);
          checkbox.className = `mr-2 ${checkboxClass}`;
          checkbox.dataset.port = port;
          checkbox.dataset.type = checkboxClass.includes("departure")
            ? "departure"
            : "arrival";

          const label = document.createElement("label");
          label.htmlFor = checkbox.id;
          label.textContent = port;
          label.className = "cursor-pointer text-xs";

          div.appendChild(checkbox);
          div.appendChild(label);
          container.appendChild(div);

          // checkbox 변경 이벤트 - 양쪽 동기화
          checkbox.addEventListener("change", (e) => {
            const port = e.target.dataset.port;
            const type = e.target.dataset.type;
            const isChecked = e.target.checked;

            // 전역 상태 업데이트
            if (isChecked) {
              if (!selectedArray.includes(port)) {
                selectedArray.push(port);
              }
            } else {
              const index = selectedArray.indexOf(port);
              if (index > -1) {
                selectedArray.splice(index, 1);
              }
            }

            // 반대편 체크박스 동기화
            const otherClass = isSidebar
              ? `${type}-port-checkbox-modal`
              : `${type}-port-checkbox-sidebar`;
            const otherCheckboxes = document.querySelectorAll(
              `.${otherClass}[data-port="${port}"]`,
            );
            otherCheckboxes.forEach((cb) => {
              if (cb !== e.target) cb.checked = isChecked;
            });

            updateSelectAllPortsCheckbox();
            updateCalendar();
          });
        });
      }

      // 전체 포트 선택 체크박스 상태 업데이트 (PC/SP 양쪽)
      function updateSelectAllPortsCheckbox() {
        // SP 모달 - 출발 포트
        const departureCheckboxesModal = document.querySelectorAll(
          ".departure-port-checkbox-modal",
        );
        const selectAllDepartureModal = document.getElementById(
          "selectAllDeparturePorts",
        );
        if (departureCheckboxesModal.length > 0 && selectAllDepartureModal) {
          const allChecked = Array.from(departureCheckboxesModal).every(
            (cb) => cb.checked,
          );
          selectAllDepartureModal.checked = allChecked;
        }

        // SP 모달 - 도착 포트
        const arrivalCheckboxesModal = document.querySelectorAll(
          ".arrival-port-checkbox-modal",
        );
        const selectAllArrivalModal = document.getElementById(
          "selectAllArrivalPorts",
        );
        if (arrivalCheckboxesModal.length > 0 && selectAllArrivalModal) {
          const allChecked = Array.from(arrivalCheckboxesModal).every(
            (cb) => cb.checked,
          );
          selectAllArrivalModal.checked = allChecked;
        }

        // PC 사이드바 - 출발 포트
        const departureCheckboxesSidebar = document.querySelectorAll(
          ".departure-port-checkbox-sidebar",
        );
        const selectAllDepartureSidebar = document.getElementById(
          "selectAllDeparturePortsSidebar",
        );
        if (
          departureCheckboxesSidebar.length > 0 &&
          selectAllDepartureSidebar
        ) {
          const allChecked = Array.from(departureCheckboxesSidebar).every(
            (cb) => cb.checked,
          );
          selectAllDepartureSidebar.checked = allChecked;
        }

        // PC 사이드바 - 도착 포트
        const arrivalCheckboxesSidebar = document.querySelectorAll(
          ".arrival-port-checkbox-sidebar",
        );
        const selectAllArrivalSidebar = document.getElementById(
          "selectAllArrivalPortsSidebar",
        );
        if (arrivalCheckboxesSidebar.length > 0 && selectAllArrivalSidebar) {
          const allChecked = Array.from(arrivalCheckboxesSidebar).every(
            (cb) => cb.checked,
          );
          selectAllArrivalSidebar.checked = allChecked;
        }
      }

      // 달력 업데이트
      function updateCalendar() {
        const { events, lineCount } = buildEvents();
        calendar.removeAllEvents();
        calendar.addEventSource(events);

        // 필터링된 건수 업데이트 (SP/PC 양쪽)
        const countElementModal = document.getElementById("filteredCount");
        if (countElementModal) {
          countElementModal.textContent = lineCount;
        }
        const countElementSidebar = document.getElementById(
          "filteredCountSidebar",
        );
        if (countElementSidebar) {
          countElementSidebar.textContent = lineCount;
        }
      }

      function parseDateStr(dateStr) {
        if (dateStr === "-") return null;
        const months = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ];
        const monIdx = months.indexOf(dateStr.slice(0, 3));
        const day = parseInt(dateStr.slice(3));
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth(); // 0-based
        let year = currentYear;

        // JSON 데이터는 0-4개월 범위의 스케줄을 제공
        // 현재 월 기준 ±4개월 범위를 벗어나면 연도 조정
        const monthDiff = monIdx - currentMonth;
        if (monthDiff > 4) {
          // 월 차이가 4보다 크면 작년 (예: 2월에 12월 데이터 → 2025년 12월)
          year = currentYear - 1;
        } else if (monthDiff < -4) {
          // 월 차이가 -4보다 작으면 내년 (예: 10월에 2월 데이터 → 2027년 2월)
          year = currentYear + 1;
        }

        return new Date(year, monIdx, day);
      }

      function buildShipSchedule(ship) {
        const scheduleItems = [];

        // 출발 항구 스케줄
        Object.entries(ship["Departure Ports"]).forEach(([port, dateStr]) => {
          if (dateStr !== "-") {
            const date = parseDateStr(dateStr);
            if (date) {
              scheduleItems.push({
                date: date,
                text: `${port} ${date.getMonth() + 1}/${date.getDate()}`,
              });
            }
          }
        });

        // 도착 항구 스케줄
        Object.entries(ship["Arrival Ports"]).forEach(([port, dateStr]) => {
          if (dateStr !== "-") {
            const date = parseDateStr(dateStr);
            if (date) {
              scheduleItems.push({
                date: date,
                text: `${port} ${date.getMonth() + 1}/${date.getDate()}`,
              });
            }
          }
        });

        // 날짜순으로 정렬
        scheduleItems.sort((a, b) => a.date - b.date);

        // 텍스트만 추출하여 join
        return scheduleItems.map((item) => item.text).join("<br>");
      }

      function buildEvents() {
        const events = [];
        let lineCount = 0;
        const filteredData =
          selectedCompanies.length === 0
            ? []
            : shippingData.filter((ship) =>
                selectedCompanies.includes(ship.Company),
              );

        filteredData.forEach((ship) => {
          const fullSchedule = buildShipSchedule(ship);

          // 해당 스케줄의 출발 날짜만 수집 (가장 빠른 출발일 ~ 가장 늦은 출발일)
          const departureDates = [];
          const departurePorts = [];
          let hasMatchingDeparturePort = false;
          let hasMatchingArrivalPort = false;

          // 출발 항구: 출발 날짜 수집 + 선택된 출발 포트 매칭 체크
          Object.entries(ship["Departure Ports"]).forEach(([port, dateStr]) => {
            if (dateStr !== "-") {
              const date = parseDateStr(dateStr);
              if (date) {
                departureDates.push(date);
                departurePorts.push(port);
              }
              // 선택된 출발 포트에 포함되어 있고 실제 값이 있으면 매칭
              if (selectedDeparturePorts.includes(port)) {
                hasMatchingDeparturePort = true;
              }
            }
          });

          // 도착 항구: 선택된 도착 포트 매칭 체크 (날짜 수집은 하지 않음)
          Object.entries(ship["Arrival Ports"]).forEach(([port, dateStr]) => {
            if (dateStr !== "-") {
              // 선택된 도착 포트에 포함되어 있고 실제 값이 있으면 매칭
              if (selectedArrivalPorts.includes(port)) {
                hasMatchingArrivalPort = true;
              }
            }
          });

          // 필터 조건 체크
          // 1. 포트가 하나도 선택되지 않았으면 모든 스케줄 표시
          // 2. 출발 포트만 선택되었으면 출발 포트 조건만 체크
          // 3. 도착 포트만 선택되었으면 도착 포트 조건만 체크
          // 4. 둘 다 선택되었으면 둘 다 만족해야 표시 (AND)
          const noDepartureSelected = selectedDeparturePorts.length === 0;
          const noArrivalSelected = selectedArrivalPorts.length === 0;

          let shouldShow = false;
          if (noDepartureSelected && noArrivalSelected) {
            // 포트 선택 없음 -> 회사만으로 표시
            shouldShow = true;
          } else if (noDepartureSelected) {
            // 도착 포트만 선택됨
            shouldShow = hasMatchingArrivalPort;
          } else if (noArrivalSelected) {
            // 출발 포트만 선택됨
            shouldShow = hasMatchingDeparturePort;
          } else {
            // 둘 다 선택됨 -> AND 조건
            shouldShow = hasMatchingDeparturePort && hasMatchingArrivalPort;
          }

          if (shouldShow && departureDates.length > 0) {
            // 출발 날짜 정렬: 가장 빠른 출발일 ~ 가장 늦은 출발일
            departureDates.sort((a, b) => a - b);

            const startDate = departureDates[0];
            const endDate = departureDates[departureDates.length - 1];

            // 종료일에 1일 추가 (FullCalendar의 end는 exclusive)
            const endDatePlusOne = new Date(endDate);
            endDatePlusOne.setDate(endDatePlusOne.getDate() + 1);

            const startFormatted = `${startDate.getFullYear()}년 ${startDate.getMonth() + 1}월 ${startDate.getDate()}일`;
            const endFormatted = `${endDate.getFullYear()}년 ${endDate.getMonth() + 1}월 ${endDate.getDate()}일`;

            // 출발 포트들을 title에 추가
            const portsText =
              departurePorts.length > 0
                ? ` (${departurePorts.join(", ")})`
                : "";

            // 기간 이벤트 (라인 스케줄)
            events.push({
              title: `${ship.Company} - ${ship["Ship Name"]} [${ship.Voyage}]${portsText}`,
              start: startDate,
              end: endDatePlusOne,
              backgroundColor: companyColors[ship.Company], // 회사별 색상 적용
              borderColor: companyColors[ship.Company], // 회사별 색상 적용
              eventType: "line",
              description: `<strong>${ship.Company}</strong><br>${ship["Ship Name"]} [${ship.Voyage}]<br><br><strong>출발 기간:</strong><br> ${startFormatted} ~ ${endFormatted}<br><br><strong>전체 스케줄:</strong><br>${fullSchedule}`,
            });
            lineCount += 1;

            // 추가: 각 출발 포트별 이벤트 (포트명 표시용)
            if (departureDates.length > 1) {
              // 출발이 하루만 있는 경우는 기간 이벤트에 포함하므로 포트 이벤트 생성하지 않음
              Object.entries(ship["Departure Ports"]).forEach(
                ([port, dateStr]) => {
                  if (dateStr !== "-") {
                    const departureDate = parseDateStr(dateStr);
                    if (departureDate) {
                      let portShouldShow = false;
                      if (noDepartureSelected && noArrivalSelected) {
                        portShouldShow = true;
                      } else if (noDepartureSelected) {
                        portShouldShow = hasMatchingArrivalPort;
                      } else if (noArrivalSelected) {
                        portShouldShow = selectedDeparturePorts.includes(port);
                      } else {
                        portShouldShow =
                          selectedDeparturePorts.includes(port) &&
                          hasMatchingArrivalPort;
                      }

                      if (portShouldShow) {
                        const dateFormatted = `${departureDate.getFullYear()}년 ${departureDate.getMonth() + 1}월 ${departureDate.getDate()}일`;
                        events.push({
                          title: `${port} [${ship.Company}]`, // 포트명 [회사명] 표시
                          start: departureDate,
                          backgroundColor: companyColors[ship.Company], // 회사 컬러 적용
                          borderColor: companyColors[ship.Company],
                          eventType: "port",
                          description: `<strong>${ship.Company}</strong><br>${ship["Ship Name"]} [${ship.Voyage}]<br><br><strong>출발:<br></strong> ${port} - ${dateFormatted}<br><br><strong>전체 스케줄:</strong><br>${fullSchedule}`,
                        });
                      }
                    }
                  }
                },
              );
            }
          }
        });
        return { events, lineCount };
      }

      function initCalendars() {
        const { events, lineCount } = buildEvents();
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();

        // 초기 필터링 건수 표시 (SP/PC 양쪽)
        const countElementModal = document.getElementById("filteredCount");
        if (countElementModal) {
          countElementModal.textContent = lineCount;
        }
        const countElementSidebar = document.getElementById(
          "filteredCountSidebar",
        );
        if (countElementSidebar) {
          countElementSidebar.textContent = lineCount;
        }

        // Calendar 1: Current month
        calendar = new FullCalendar.Calendar(
          document.getElementById("calendar"),
          {
            initialView: "dayGridMonth",
            multiMonthMaxColumns: 1,
            initialDate: new Date(currentYear, currentMonth, 1),
            events: events,
            height: "90vh",
            headerToolbar: {
              left: "dayGridMonth,dayGridWeek",
              center: "title",
              right: "today,prev,next",
            },
            eventContent: function (info) {
              // 기간 이벤트는 회사명, 선박 이름, voyage 표시하여 타이틀 생략 방지
              if (info.event.title.includes(" - ")) {
                const parts = info.event.title.split(" - ");
                const company = parts[0];
                const rest = parts[1];
                const shipName = rest.split(" [")[0];
                const voyage = rest.split(" [")[1].split("]")[0];

                // 출발이 하루만 있는 기간 이벤트는 포트 이벤트처럼 회사 컬러 원 추가 + 포트명 포함
                const isSingleDay =
                  (new Date(info.event.end) - new Date(info.event.start)) /
                    (1000 * 60 * 60 * 24) ===
                  1;
                if (isSingleDay) {
                  const color = info.event.backgroundColor;
                  const portText = rest.split("]")[1].trim(); // " (포트명)"
                  const portName = portText ? portText.slice(1, -1) : ""; // 포트명 추출
                  return {
                    html: `<span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: ${color}; margin-right: 5px; flex: none;"></span>${shipName} [${voyage}] (${portName})`,
                  };
                } else {
                  return {
                    html: `<span style="padding: 0 3px;"><strong>${company}</strong> - ${shipName} [${voyage}]</span>`,
                  };
                }
              } else {
                // 포트 이벤트: 회사 컬러 원 + 포트명
                const color = info.event.backgroundColor;
                const portName = info.event.title.split(" [")[0]; // 포트명만 추출
                return {
                  html: `<span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: ${color}; margin-right: 5px; flex: none;"></span>${portName}`,
                };
              }
            },
            eventMouseEnter: function (info) {
              // 툴팁 표시
              const tooltip = document.createElement("div");
              tooltip.className = "fc-tooltip";
              tooltip.innerHTML = info.event.extendedProps.description;
              tooltip.style.position = "fixed";
              tooltip.style.background = "white";
              tooltip.style.border = "1px solid #ccc";
              tooltip.style.zIndex = "10000";
              tooltip.style.pointerEvents = "none";
              document.body.appendChild(tooltip);
              const rect = info.el.getBoundingClientRect();
              tooltip.style.left = rect.left + 50 + "px";
              tooltip.style.top = rect.top + 25 + "px";
              info.el.tooltip = tooltip;
            },
            eventMouseLeave: function (info) {
              // 툴팁 제거
              if (info.el.tooltip) {
                document.body.removeChild(info.el.tooltip);
                info.el.tooltip = null;
              }
            },
          },
        );
        calendar.render();

        // 전역 키보드 조작 추가
        document.addEventListener("keydown", function (event) {
          // 캘린더가 초기화된 경우에만 실행
          if (calendar) {
            if (event.key === "ArrowLeft") {
              calendar.prev(); // 이전 달로 이동
              event.preventDefault(); // 기본 동작 방지
            } else if (event.key === "ArrowRight") {
              calendar.next(); // 다음 달로 이동
              event.preventDefault(); // 기본 동작 방지
            } else if (event.key === "ArrowUp") {
              calendar.today(); // 오늘로 이동
              event.preventDefault();
            }
          }
        });
      }
    </script>
  </body>
</html>
